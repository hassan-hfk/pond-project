<!DOCTYPE html>
<html>
<head>
    <title>Video Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .video-container { margin: 20px 0; }
        video { max-width: 800px; border: 1px solid #ccc; background: #000; }
        .debug-info { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .file-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; }
        button { margin: 2px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>Video Playback Test</h1>
    
    <div class="debug-info">
        <h3>Debug Controls</h3>
        <button onclick="loadFiles()">Load Available Files</button>
        <button onclick="testDirectPlay()">Test Direct Play</button>
        <div id="debugOutput"></div>
    </div>

    <div class="video-container">
        <h3>Video Player</h3>
        <video id="testVideo" controls width="800" height="450">
            Your browser does not support the video tag.
        </video>
        <div>
            <strong>Current Source:</strong> <span id="currentSource">None</span>
        </div>
    </div>

    <div id="filesList"></div>

    <script>
        async function loadFiles() {
            try {
                const response = await fetch('/api/debug/files');
                const files = await response.json();
                
                let html = '<h3>Available Video Files</h3>';
                if (files.length === 0) {
                    html += '<p>No video files found in recordings directory.</p>';
                } else {
                    files.forEach(file => {
                        html += `
                        <div class="file-item">
                            <strong>${file.filename}</strong> (${file.size_mb} MB)<br>
                            <button onclick="playVideo('${file.url}')">Play via /recordings</button>
                            <button onclick="playVideo('${file.direct_url}')">Play via /video_file</button>
                            <button onclick="testVideo('${file.filename}')">Test All Methods</button>
                        </div>
                        `;
                    });
                }
                
                document.getElementById('filesList').innerHTML = html;
                document.getElementById('debugOutput').innerHTML = 
                    `Found ${files.length} video files`;
                
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('debugOutput').innerHTML = 'Error: ' + error.message;
            }
        }

        function playVideo(url) {
            const video = document.getElementById('testVideo');
            const source = document.getElementById('currentSource');
            
            console.log('Attempting to play:', url);
            source.textContent = url;
            
            // Clear previous sources
            video.innerHTML = '';
            
            // Create new source element
            const sourceElement = document.createElement('source');
            sourceElement.src = url;
            sourceElement.type = 'video/mp4'; // Default type
            
            video.appendChild(sourceElement);
            video.load();
            
            video.play().then(() => {
                console.log('Video started playing');
                document.getElementById('debugOutput').innerHTML = 
                    `‚úÖ Playing: ${url}`;
            }).catch(e => {
                console.error('Error playing video:', e);
                document.getElementById('debugOutput').innerHTML = 
                    `‚ùå Play error: ${e.message} - Trying fallback...`;
                
                // Try with different MIME type
                setTimeout(() => tryFallbackPlay(url), 100);
            });
        }

        function tryFallbackPlay(url) {
            const video = document.getElementById('testVideo');
            video.innerHTML = '';
            
            const sourceElement = document.createElement('source');
            sourceElement.src = url;
            sourceElement.type = 'video/webm'; // Try different type
            
            video.appendChild(sourceElement);
            video.load();
            
            video.play().catch(e => {
                console.error('Fallback also failed:', e);
                document.getElementById('debugOutput').innerHTML = 
                    `‚ùå All playback attempts failed: ${e.message}<br>
                     Check browser console for details.`;
            });
        }

        async function testDirectPlay() {
            // Test direct file access
            const testUrl = '/recordings/test_video.mp4';
            playVideo(testUrl);
        }

        async function testVideo(filename) {
            // Test all serving methods for a file
            const methods = [
                `/recordings/${filename}`,
                `/video_file/${filename}`
            ];
            
            document.getElementById('debugOutput').innerHTML = 
                `Testing ${filename} with ${methods.length} methods...`;
            
            for (let method of methods) {
                try {
                    const response = await fetch(method);
                    if (response.ok) {
                        document.getElementById('debugOutput').innerHTML += 
                            `<br>‚úÖ ${method}: Accessible`;
                    } else {
                        document.getElementById('debugOutput').innerHTML += 
                            `<br>‚ùå ${method}: ${response.status} ${response.statusText}`;
                    }
                } catch (error) {
                    document.getElementById('debugOutput').innerHTML += 
                        `<br>‚ùå ${method}: ${error.message}`;
                }
            }
        }

        // Load files on page load
        loadFiles();
        
        // Add event listeners for video errors
        document.getElementById('testVideo').addEventListener('error', function(e) {
            console.error('Video error:', e);
            document.getElementById('debugOutput').innerHTML += 
                '<br>üé¨ Video element error - check console';
        });
    </script>
</body>
</html>