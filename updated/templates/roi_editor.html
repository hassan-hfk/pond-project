<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ROI Editor - Detection System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 200px;
        background-color: #2c3e50;
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .sidebar-btn {
        width: 160px;
        padding: 15px 20px;
        margin: 10px 0;
        background-color: #34495e;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      .sidebar-btn:hover {
        background-color: #1abc9c;
      }

      .sidebar-btn.active {
        background-color: #1abc9c;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      .control-panel {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .control-panel button {
        padding: 12px 25px;
        margin-right: 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }

      #startMarkingBtn {
        background-color: #27ae60;
        color: white;
      }

      #stopMarkingBtn {
        background-color: #e74c3c;
        color: white;
      }

      #saveRoisBtn {
        background-color: #3498db;
        color: white;
      }

      .video-container {
        flex: 1;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .video-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: crosshair;
      }

      .status {
        margin-top: 10px;
        padding: 10px;
        background: #ecf0f1;
        border-radius: 5px;
        font-weight: bold;
      }

      .instructions {
        margin-top: 10px;
        padding: 10px;
        background: #fff3cd;
        border-radius: 5px;
        color: #856404;
        font-size: 14px;
      }

      .points-list {
        margin-top: 10px;
        max-height: 100px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar with 5 Buttons -->
        <div class="sidebar">
            <button class="sidebar-btn" onclick="window.location.href='/'">Detection</button>
            <button class="sidebar-btn active">ROI Editor</button>
            <button class="sidebar-btn">Button 3</button>
            <button class="sidebar-btn">Button 4</button>
            <button class="sidebar-btn">Button 5</button>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Control Buttons for ROI Editing -->
            <div class="control-panel">
                <button id="startMarkingBtn">Start Marking ROI</button>
                <button id="stopMarkingBtn" disabled>Stop Marking ROI</button>
                <button id="saveRoisBtn">Save ROIs to Config</button>
                <div class="status">Status: <span id="statusText">Ready - Click Start Marking to begin</span></div>
                <div class="instructions" id="instructions">
                    Instructions: Click "Start Marking ROI" then click on the video to add polygon points. Right-click to remove last point.
                </div>
                <div class="points-list" id="pointsList">
                    No points added yet
                </div>
            </div>

            <!-- Video Feed for ROI Editing -->
            <div class="video-container">
                <img src="{{ url_for('roi_video_feed') }}" alt="ROI Editor Video Feed" id="roiVideoFeed" />
            </div>
        </div>
    </div>

    <script>
        let isMarking = false;
        let points = [];

        // Start Marking ROI
        document.getElementById("startMarkingBtn").addEventListener("click", function () {
            isMarking = true;
            points = [];
            updateUI();
            document.getElementById("statusText").textContent = "Marking Active - Click on video to add points";
            document.getElementById("statusText").style.color = "green";
            document.getElementById("instructions").textContent = "Click on video to add polygon points. Right-click to remove last point. Need at least 3 points.";
        });

        // Stop Marking ROI
        document.getElementById("stopMarkingBtn").addEventListener("click", function () {
            isMarking = false;
            updateUI();
            document.getElementById("statusText").textContent = "Marking Stopped - " + points.length + " points collected";
            document.getElementById("statusText").style.color = "blue";
        });

        // Save ROIs to Config
        document.getElementById("saveRoisBtn").addEventListener("click", function () {
            if (points.length < 3) {
                alert("Need at least 3 points to create a polygon");
                return;
            }

            fetch("/save_rois", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ points: points })
            })
            .then((response) => response.json())
            .then((data) => {
                document.getElementById("statusText").textContent = "ROIs Saved Successfully!";
                document.getElementById("statusText").style.color = "green";
                console.log("Save ROIs:", data);
            })
            .catch((error) => {
                console.error("Error saving ROIs:", error);
                document.getElementById("statusText").textContent = "Error saving ROIs";
                document.getElementById("statusText").style.color = "red";
            });
        });

        // Mouse click handler for video feed
        document.getElementById("roiVideoFeed").addEventListener("click", function (event) {
            if (!isMarking) return;

            const rect = this.getBoundingClientRect();
            const x = (event.clientX - rect.left) / rect.width;
            const y = (event.clientY - rect.top) / rect.height;

            // Add point
            points.push([x, y]);
            updatePointsList();
        });

        // Right-click handler to remove last point
        document.getElementById("roiVideoFeed").addEventListener("contextmenu", function (event) {
            if (!isMarking) return;
            event.preventDefault();
            
            if (points.length > 0) {
                points.pop();
                updatePointsList();
            }
        });

        function updateUI() {
            document.getElementById("startMarkingBtn").disabled = isMarking;
            document.getElementById("stopMarkingBtn").disabled = !isMarking;
        }

        function updatePointsList() {
            const pointsList = document.getElementById("pointsList");
            if (points.length === 0) {
                pointsList.textContent = "No points added yet";
            } else {
                pointsList.innerHTML = points.map((point, index) => 
                    `Point ${index + 1}: [${point[0].toFixed(4)}, ${point[1].toFixed(4)}]`
                ).join('<br>');
            }
            
            document.getElementById("statusText").textContent = 
                `Marking Active - ${points.length} points collected${points.length >= 3 ? ' (Ready to save)' : ''}`;
        }

        // Sidebar button functionality
        document.querySelectorAll(".sidebar-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
                document.querySelectorAll(".sidebar-btn").forEach((b) => b.classList.remove("active"));
                this.classList.add("active");
            });
        });

        // Handle video feed errors
        document.getElementById("roiVideoFeed").addEventListener("error", function () {
            console.error("ROI Video feed error");
            this.alt = "ROI Video feed not available";
        });
    </script>
</body>
</html>