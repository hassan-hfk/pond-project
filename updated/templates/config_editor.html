<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Config Editor - Detection System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 200px;
        background-color: #2c3e50;
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .sidebar-btn {
        width: 160px;
        padding: 15px 20px;
        margin: 10px 0;
        background-color: #34495e;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      .sidebar-btn:hover {
        background-color: #1abc9c;
      }

      .sidebar-btn.active {
        background-color: #1abc9c;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
      }

      .config-panel {
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .section {
        margin-bottom: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #3498db;
      }

      .section-title {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 18px;
        font-weight: bold;
      }

      .field-group {
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }

      .field-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 5px 0;
      }

      .field-label {
        width: 200px;
        font-weight: bold;
        color: #2c3e50;
        font-size: 14px;
      }

      .field-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .array-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 5px;
        background: #f8f9fa;
        border-radius: 3px;
      }

      .array-input {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 13px;
        margin-right: 10px;
      }

      .remove-btn {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
      }

      .add-btn {
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        margin-top: 5px;
      }

      .nested-section {
        margin-left: 20px;
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
      }

      .save-button {
        background-color: #27ae60;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 20px;
      }

      .save-button:hover {
        background-color: #219a52;
      }

      .status {
        margin-top: 15px;
        padding: 10px;
        background: #ecf0f1;
        border-radius: 5px;
        font-weight: bold;
      }

      .roi-point {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 8px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .roi-coord {
        flex: 1;
        margin: 0 5px;
      }

      .help-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }

      .thresholds-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
      }

      .threshold-item {
        padding: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar with 5 Buttons -->
        <div class="sidebar">
            <button class="sidebar-btn" onclick="window.location.href='/'">Detection</button>
            <button class="sidebar-btn" onclick="window.location.href='/roi_editor'">ROI Editor</button>
            <button class="sidebar-btn active">Config Editor</button>
            <button class="sidebar-btn">Button 4</button>
            <button class="sidebar-btn">Button 5</button>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Config Editor -->
            <div class="config-panel">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Configuration Editor</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Edit all configuration parameters. Changes will be saved to config.yaml</p>
                
                <div id="configForm">
                    <!-- Configuration will be dynamically loaded here -->
                </div>

                <button class="save-button" onclick="saveConfig()">Save All Configuration</button>
                <div class="status" id="statusText">Ready - Configuration will be loaded shortly...</div>
            </div>
        </div>
    </div>

    <script>
        // Load full config when page loads
        window.addEventListener('load', function() {
            loadFullConfig();
        });

        function loadFullConfig() {
            fetch('/get_full_config')
                .then(response => response.json())
                .then(data => {
                    renderConfigForm(data.config);
                    document.getElementById('statusText').textContent = 'Configuration loaded successfully';
                    document.getElementById('statusText').style.color = 'green';
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    document.getElementById('statusText').textContent = 'Error loading configuration';
                    document.getElementById('statusText').style.color = 'red';
                });
        }

        function renderConfigForm(config) {
            const formContainer = document.getElementById('configForm');
            formContainer.innerHTML = '';

            // Render each section in the exact order from your config
            renderSection(formContainer, 'calibration', config.calibration || {});
            renderSection(formContainer, 'camera', config.camera || {});
            renderSection(formContainer, 'gpio', config.gpio || {});
            renderSection(formContainer, 'logging', config.logging || {});
            renderSection(formContainer, 'model', config.model || {});
            renderROISection(formContainer, 'rois', config.rois || []);
            renderThresholdsSection(formContainer, 'thresholds', config.thresholds || {});
        }

        function renderSection(container, sectionName, sectionData) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            sectionDiv.appendChild(title);

            for (const [key, value] of Object.entries(sectionData)) {
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';
                
                if (Array.isArray(value)) {
                    // Handle arrays
                    renderArrayField(fieldGroup, sectionName, key, value);
                } else if (typeof value === 'object' && value !== null) {
                    // Handle nested objects
                    renderNestedObject(fieldGroup, sectionName, key, value);
                } else {
                    // Handle simple values
                    renderSimpleField(fieldGroup, sectionName, key, value);
                }
                
                sectionDiv.appendChild(fieldGroup);
            }
            
            container.appendChild(sectionDiv);
        }

        function renderThresholdsSection(container, sectionName, sectionData) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = 'Thresholds';
            title.innerHTML += ' <span style="font-size: 12px; color: #6c757d;">(Detection sensitivity parameters)</span>';
            sectionDiv.appendChild(title);

            const gridContainer = document.createElement('div');
            gridContainer.className = 'thresholds-grid';

            // Render each threshold parameter in a grid layout
            for (const [key, value] of Object.entries(sectionData)) {
                const thresholdItem = document.createElement('div');
                thresholdItem.className = 'threshold-item';
                
                if (key === 'classes_trigger' && Array.isArray(value)) {
                    // Special handling for classes_trigger array
                    renderClassesTrigger(thresholdItem, sectionName, key, value);
                } else {
                    // Regular threshold parameters
                    renderThresholdField(thresholdItem, sectionName, key, value);
                }
                
                gridContainer.appendChild(thresholdItem);
            }
            
            sectionDiv.appendChild(gridContainer);
            container.appendChild(sectionDiv);
        }

        function renderThresholdField(container, section, key, value) {
            const label = document.createElement('div');
            label.className = 'field-label';
            
            // Human-readable labels
            const labels = {
                'dwell_time': 'Dwell Time (seconds)',
                'height_m': 'Height Threshold (meters)',
                'iou_threshold': 'IOU Threshold',
                'consecutive_frames': 'Consecutive Frames'
            };
            
            label.textContent = labels[key] || key;
            container.appendChild(label);
            
            const input = document.createElement('input');
            
            // Set appropriate input types and ranges
            if (key === 'dwell_time') {
                input.type = 'number';
                input.step = '0.5';
                input.min = '0.5';
                input.max = '10';
                input.title = 'Minimum time person must stay in ROI to trigger (seconds)';
            } else if (key === 'height_m') {
                input.type = 'number';
                input.step = '0.1';
                input.min = '0.1';
                input.max = '2.0';
                input.title = 'Minimum height to trigger detection (meters)';
            } else if (key === 'iou_threshold') {
                input.type = 'number';
                input.step = '0.01';
                input.min = '0.01';
                input.max = '1.0';
                input.title = 'Intersection Over Union threshold for detection matching';
            } else if (key === 'consecutive_frames') {
                input.type = 'number';
                input.step = '1';
                input.min = '1';
                input.max = '10';
                input.title = 'Number of consecutive frames required for detection';
            } else {
                input.type = typeof value === 'number' ? 'number' : 'text';
            }
            
            input.className = 'field-input';
            input.value = value;
            input.setAttribute('data-section', section);
            input.setAttribute('data-key', key);
            input.setAttribute('data-type', 'simple');
            container.appendChild(input);

            // Add help text
            const helpText = document.createElement('div');
            helpText.className = 'help-text';
            
            const helpMessages = {
                'dwell_time': 'Min. seconds person must stay in ROI',
                'height_m': 'Min. height to trigger detection',
                'iou_threshold': 'IOU threshold for detection matching',
                'consecutive_frames': 'Frames needed for stable detection'
            };
            
            helpText.textContent = helpMessages[key] || '';
            container.appendChild(helpText);
        }

        function renderClassesTrigger(container, section, key, classes) {
            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = 'Detection Classes';
            label.style.marginBottom = '10px';
            container.appendChild(label);

            const classesContainer = document.createElement('div');
            classesContainer.id = 'classesContainer';
            classesContainer.style.marginBottom = '10px';
            
            classes.forEach((className, index) => {
                const classTag = document.createElement('div');
                classTag.className = 'array-item';
                
                const classInput = document.createElement('input');
                classInput.type = 'text';
                classInput.className = 'array-input';
                classInput.value = className;
                classInput.setAttribute('data-section', section);
                classInput.setAttribute('data-key', key);
                classInput.setAttribute('data-index', index);
                classInput.setAttribute('data-type', 'array');
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = function() {
                    classTag.remove();
                };
                
                classTag.appendChild(classInput);
                classTag.appendChild(removeBtn);
                classesContainer.appendChild(classTag);
            });
            
            container.appendChild(classesContainer);

            const addClassContainer = document.createElement('div');
            addClassContainer.style.display = 'flex';
            addClassContainer.style.gap = '10px';
            addClassContainer.style.marginTop = '10px';
            
            const newClassInput = document.createElement('input');
            newClassInput.type = 'text';
            newClassInput.placeholder = 'Add new class (e.g., person, car)';
            newClassInput.style.flex = '1';
            newClassInput.id = 'newClassInput';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.textContent = 'Add Class';
            addBtn.onclick = function() {
                const newClass = newClassInput.value.trim();
                if (newClass) {
                    const newClassTag = document.createElement('div');
                    newClassTag.className = 'array-item';
                    
                    const newClassInputField = document.createElement('input');
                    newClassInputField.type = 'text';
                    newClassInputField.className = 'array-input';
                    newClassInputField.value = newClass;
                    newClassInputField.setAttribute('data-section', section);
                    newClassInputField.setAttribute('data-key', key);
                    newClassInputField.setAttribute('data-index', classesContainer.children.length);
                    newClassInputField.setAttribute('data-type', 'array');
                    
                    const newRemoveBtn = document.createElement('button');
                    newRemoveBtn.className = 'remove-btn';
                    newRemoveBtn.textContent = 'Remove';
                    newRemoveBtn.onclick = function() {
                        newClassTag.remove();
                    };
                    
                    newClassTag.appendChild(newClassInputField);
                    newClassTag.appendChild(newRemoveBtn);
                    classesContainer.appendChild(newClassTag);
                    
                    newClassInput.value = '';
                }
            };
            
            addClassContainer.appendChild(newClassInput);
            addClassContainer.appendChild(addBtn);
            container.appendChild(addClassContainer);

            const helpText = document.createElement('div');
            helpText.className = 'help-text';
            helpText.textContent = 'Object classes that will trigger detection events';
            container.appendChild(helpText);
        }

        function renderSimpleField(container, section, key, value) {
            const fieldRow = document.createElement('div');
            fieldRow.className = 'field-row';
            
            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = key;
            fieldRow.appendChild(label);
            
            const input = document.createElement('input');
            input.type = typeof value === 'number' ? 'number' : 'text';
            input.className = 'field-input';
            input.value = value;
            input.setAttribute('data-section', section);
            input.setAttribute('data-key', key);
            input.setAttribute('data-type', 'simple');
            fieldRow.appendChild(input);
            
            container.appendChild(fieldRow);
        }

        function renderArrayField(container, section, key, array) {
            const fieldRow = document.createElement('div');
            fieldRow.className = 'field-row';
            
            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = key;
            fieldRow.appendChild(label);
            
            const arrayContainer = document.createElement('div');
            arrayContainer.style.flex = '1';
            
            array.forEach((item, index) => {
                const arrayItem = document.createElement('div');
                arrayItem.className = 'array-item';
                
                const input = document.createElement('input');
                input.type = typeof item === 'number' ? 'number' : 'text';
                input.className = 'array-input';
                input.value = item;
                input.setAttribute('data-section', section);
                input.setAttribute('data-key', key);
                input.setAttribute('data-index', index);
                input.setAttribute('data-type', 'array');
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = function() {
                    arrayItem.remove();
                };
                
                arrayItem.appendChild(input);
                arrayItem.appendChild(removeBtn);
                arrayContainer.appendChild(arrayItem);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.textContent = 'Add Item';
            addBtn.onclick = function() {
                const newItem = document.createElement('div');
                newItem.className = 'array-item';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.className = 'array-input';
                newInput.value = '';
                newInput.setAttribute('data-section', section);
                newInput.setAttribute('data-key', key);
                newInput.setAttribute('data-index', arrayContainer.children.length);
                newInput.setAttribute('data-type', 'array');
                
                const newRemoveBtn = document.createElement('button');
                newRemoveBtn.className = 'remove-btn';
                newRemoveBtn.textContent = 'Remove';
                newRemoveBtn.onclick = function() {
                    newItem.remove();
                };
                
                newItem.appendChild(newInput);
                newItem.appendChild(newRemoveBtn);
                arrayContainer.appendChild(newItem);
            };
            
            fieldRow.appendChild(arrayContainer);
            container.appendChild(fieldRow);
            container.appendChild(addBtn);
        }

        function renderNestedObject(container, section, key, nestedObj) {
            const fieldRow = document.createElement('div');
            fieldRow.className = 'field-row';
            
            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = key;
            fieldRow.appendChild(label);
            
            const nestedContainer = document.createElement('div');
            nestedContainer.className = 'nested-section';
            nestedContainer.style.flex = '1';
            
            for (const [nestedKey, nestedValue] of Object.entries(nestedObj)) {
                const nestedField = document.createElement('div');
                nestedField.className = 'field-row';
                
                const nestedLabel = document.createElement('div');
                nestedLabel.className = 'field-label';
                nestedLabel.textContent = nestedKey;
                nestedLabel.style.width = '150px';
                nestedField.appendChild(nestedLabel);
                
                const nestedInput = document.createElement('input');
                nestedInput.type = typeof nestedValue === 'number' ? 'number' : 'text';
                nestedInput.className = 'field-input';
                nestedInput.value = nestedValue;
                nestedInput.setAttribute('data-section', section);
                nestedInput.setAttribute('data-key', key + '.' + nestedKey);
                nestedInput.setAttribute('data-type', 'nested');
                nestedField.appendChild(nestedInput);
                
                nestedContainer.appendChild(nestedField);
            }
            
            fieldRow.appendChild(nestedContainer);
            container.appendChild(fieldRow);
        }

        function renderROISection(container, sectionName, rois) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = 'ROIs';
            title.innerHTML += ' <span style="font-size: 12px; color: #6c757d;">(Use ROI Editor to modify)</span>';
            sectionDiv.appendChild(title);

            const helpText = document.createElement('div');
            helpText.className = 'help-text';
            helpText.textContent = 'ROIs are managed through the ROI Editor page. Changes here should be made in the dedicated ROI Editor.';
            sectionDiv.appendChild(helpText);

            if (rois.length > 0 && rois[0].length > 0) {
                const roiInfo = document.createElement('div');
                roiInfo.style.marginTop = '10px';
                roiInfo.innerHTML = `<strong>Current ROI:</strong> ${rois[0].length} points defined`;
                sectionDiv.appendChild(roiInfo);
            } else {
                const roiInfo = document.createElement('div');
                roiInfo.style.marginTop = '10px';
                roiInfo.innerHTML = `<strong>No ROI defined</strong> - Use ROI Editor to create one`;
                roiInfo.style.color = '#e74c3c';
                sectionDiv.appendChild(roiInfo);
            }
            
            container.appendChild(sectionDiv);
        }

        function saveConfig() {
            const configData = collectFormData();
            
            fetch('/save_full_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ config: configData })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('statusText').textContent = 'Configuration saved successfully!';
                document.getElementById('statusText').style.color = 'green';
                console.log('Save config:', data);
            })
            .catch(error => {
                console.error('Error saving config:', error);
                document.getElementById('statusText').textContent = 'Error saving configuration';
                document.getElementById('statusText').style.color = 'red';
            });
        }

        function collectFormData() {
            const config = {
                calibration: {},
                camera: {},
                gpio: {},
                logging: {},
                model: {},
                rois: window.currentROIs || [], // Preserve ROIs from original config
                thresholds: {}
            };

            // Collect all form fields
            document.querySelectorAll('input[data-section]').forEach(input => {
                const section = input.getAttribute('data-section');
                const key = input.getAttribute('data-key');
                const type = input.getAttribute('data-type');
                
                if (type === 'simple') {
                    config[section][key] = parseValue(input.value);
                } else if (type === 'nested') {
                    const keys = key.split('.');
                    let current = config[section];
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = parseValue(input.value);
                } else if (type === 'array') {
                    if (!config[section][key]) {
                        config[section][key] = [];
                    }
                    // Arrays are collected separately below
                }
            });

            // Collect array values
            document.querySelectorAll('input[data-type="array"]').forEach(input => {
                const section = input.getAttribute('data-section');
                const key = input.getAttribute('data-key');
                if (!config[section][key]) {
                    config[section][key] = [];
                }
                if (input.value.trim() !== '') {
                    config[section][key].push(parseValue(input.value));
                }
            });

            return config;
        }

        function parseValue(value) {
            if (value === 'null') return null;
            if (value === 'true') return true;
            if (value === 'false') return false;
            if (!isNaN(value) && value.trim() !== '') return Number(value);
            return value;
        }

        // Sidebar button functionality
        document.querySelectorAll(".sidebar-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
                document.querySelectorAll(".sidebar-btn").forEach((b) => b.classList.remove("active"));
                this.classList.add("active");
            });
        });
    </script>
</body>
</html>